import{_ as s,c as i,o as a,V as e}from"./chunks/framework.heQuCCy3.js";const E=JSON.parse('{"title":"权限介绍","description":"","frontmatter":{},"headers":[],"relativePath":"server/permission.md","filePath":"server/permission.md","lastUpdated":1705459633000}'),n={name:"server/permission.md"},l=e(`<h1 id="权限介绍" tabindex="-1">权限介绍 <a class="header-anchor" href="#权限介绍" aria-label="Permalink to &quot;权限介绍&quot;">​</a></h1><p>权限是大家所熟知的<code>RBAC</code>权限，即用户一对多角色，角色一对多权限。如果对 <code>RBAC</code> 权限没有足够的了解可以看一下这篇<a href="https://docs.oracle.com/cd/E19253-01/819-7061/rbac-38/index.html" target="_blank" rel="noreferrer">基于角色的访问控制</a> 的 blog。</p><h2 id="基本约定" tabindex="-1">基本约定 <a class="header-anchor" href="#基本约定" aria-label="Permalink to &quot;基本约定&quot;">​</a></h2><ul><li>超级管理员不受任何权限控制</li><li>对于<code>RBAC</code>权限，<code>GET</code>请求是默认放行，不受权限限制</li></ul><h2 id="权限模块" tabindex="-1">权限模块 <a class="header-anchor" href="#权限模块" aria-label="Permalink to &quot;权限模块&quot;">​</a></h2><p><code>catchadmin</code> 默认不开启权限模块，也不使用动态菜单。所以第一步应该是开启模块</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> artisan</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> permissions</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>开启之后如果没有权限菜单，可以刷新一下</p></div><h3 id="中间件" tabindex="-1">中间件 <a class="header-anchor" href="#中间件" aria-label="Permalink to &quot;中间件&quot;">​</a></h3><p>权限模块提供了权限控制的中间件，如下</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PermissionGate</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $request, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\Closure</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $next)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // get 请求全部通过</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;get&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $next($request);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* @var User $user */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getGuardName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 没有权限则被拦截</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">can</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PermissionForbidden</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $next($request);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="添加权限" tabindex="-1">添加权限 <a class="header-anchor" href="#添加权限" aria-label="Permalink to &quot;添加权限&quot;">​</a></h3><p>其实上面的稍做了解即可，最重要还是看看权限是由哪些元数据组成。因为这是前后端的项目，所以比一般渲染的要复杂一点，但并不是不能做，前提一定要先去了解 <a href="https://router.vuejs.org/" target="_blank" rel="noreferrer"><code>vue 的路由</code></a>相关知识。首先找到<strong>权限管理/菜单管理</strong>页面，点击新增，看到以下界面</p><p><img src="https://s1.ax1x.com/2023/01/16/pSl4dVP.png" alt="pSl4dVP.png"><code>CatchAdmin</code> 将权限分为三种类型</p><ul><li><p><strong>目录</strong> 目录仅仅就是一级菜单</p></li><li><p><strong>菜单</strong> 菜单就是主要的页面</p></li><li><p><strong>按钮</strong> 每个页面的操作，每个按钮都对应后端的控制的一个 <code>action</code>，这个非常重要</p></li><li><p>路由 <code>Path</code> 对应前端 <code>vue</code> 路由的 <code>path</code></p></li><li><p>组件 对应前端 <code>vue</code> 路由的 <code>component</code></p><ul><li>目录类型一般都是选择 Layout 组件</li><li>菜单类型则是选择对应页面的组件</li></ul></li></ul><p>传统的 <code>Laravel</code> 项目，<code>RBAC</code> 都可以通过 <code>Controller</code> 来控制页面以及页面操作的权限控制。其实前后端分离的项目也是一样，只不过对于传统的渲染项目，页面也是由 PHP 控制的。前后端分离之后，页面都交给了前端，但是数据操作并没有交给前端，所以对于前后端分离的项目，<code>RBAC</code> 主要的作用就是控制<code>API</code>访问，上面的几个概念都是由前端控制的。后端的着重点在<code>按钮类型</code>, 即对控制器的<code>action</code> 控制。 所以后端需要添加控制器的每一个<code>action</code>操作, 针对这些 <code>action</code> 进行权限赋予。</p><h3 id="权限判断" tabindex="-1">权限判断 <a class="header-anchor" href="#权限判断" aria-label="Permalink to &quot;权限判断&quot;">​</a></h3><p><code>catchadmin</code> 使用模块化，所以权限标识的格式是这样的</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>module@controller@action</span></span></code></pre></div><p>例如权限模块的角色列表，最后进行权限判断的格式就是这样的</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Modules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\\</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">permissions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\\</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\\</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Controller</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\\</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">RolesController</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">index</span></span></code></pre></div><h4 id="当前用户是否有权限" tabindex="-1">当前用户是否有权限 <a class="header-anchor" href="#当前用户是否有权限" aria-label="Permalink to &quot;当前用户是否有权限&quot;">​</a></h4><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Auth</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">can</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $permission </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><ul><li>permissions 如果需要判断某个特定的权限，permission 参数格式: module@controller@action, 例如 <code>permission@Roles@index</code></li></ul><h4 id="用户的权限" tabindex="-1">用户的权限 <a class="header-anchor" href="#用户的权限" aria-label="Permalink to &quot;用户的权限&quot;">​</a></h4><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/*@var Model\\Roles $user*/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">withPermissions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">permissions;</span></span></code></pre></div><h4 id="角色权限" tabindex="-1">角色权限 <a class="header-anchor" href="#角色权限" aria-label="Permalink to &quot;角色权限&quot;">​</a></h4><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/*@var Model\\Roles $role*/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$role</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getPermissions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div>`,28),t=[l];function h(p,k,r,d,o,c){return a(),i("div",null,t)}const y=s(n,[["render",h]]);export{E as __pageData,y as default};
